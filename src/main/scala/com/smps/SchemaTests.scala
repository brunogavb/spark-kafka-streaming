package com.smps

import org.apache.spark.sql.{DataFrame, Dataset, Row, SaveMode}
import org.apache.spark.sql.avro.SchemaConverters
import org.apache.avro.Conversion
import org.apache.spark.sql.functions.input_file_name
import org.apache.spark.sql.streaming.Trigger
import org.kitesdk.data.spi.{JsonUtil, SchemaUtil}
import org.apache.spark.sql.types.{StructField, StructType}

//toAvroType
import org.apache.avro.{LogicalTypes, Schema, SchemaBuilder, Conversion}
import org.apache.spark.sql.types._
import org.apache.spark.sql.types.Decimal.minBytesForPrecision

//.option("badRecordsPath", "/tmp/badRecordsPath")

object SchemaTests extends App {

  val spark = com.smps.util.Connections.getSparkSession
  val basePath = "file:///Users/bcanal/Workspace/datalake-consumer-event/src/main/resources"
  val pathCPRelative = "/raw/payments/payment_cp/payments"
  val pathCNPRelative = "/raw/payments/payment_cnp/payments"
  val pathCPAndCNP = "/raw/payments/payment_{cp,cnp}/payments/year=*/month=*/day=*/*.avro"

  val schemaCPHandled  = Schema.parse(""" {"type":"record","name":"topLevelRecord","fields":[{"default": null,"name":"offset","type":["null","long"]},{"default": null,"name":"timestamp","type":[{"type":"long","logicalType":"timestamp-micros"},"null"]},{"default": null,"name":"payload","type":[{"type":"record","default": null,"name":"payload","namespace":"topLevelRecord","fields":[{"default": null,"name":"metadata","type":[{"type":"record","default": null,"name":"metadata","namespace":"topLevelRecord.payload","fields":[{"default": null,"name":"_data","type":["null","string"]},{"default": null,"name":"coll","type":["null","string"]},{"default": null,"name":"db","type":["null","string"]},{"default": null,"name":"operation_type","type":["null","string"]}]},"null"]},{"default": null,"name":"payload","type":[{"type":"record","default": null,"name":"payload","namespace":"topLevelRecord.payload","fields":[{"default": null,"name":"__v","type":["null","long"]},{"default": null,"name":"_id","type":[{"type":"record","default": null,"name":"_id","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"oid","type":["null","string"]}]},"null"]},{"default": null,"name":"acquirer_code","type":["null","long"]},{"default": null,"name":"acquirer_country_code","type":["null","string"]},{"default": null,"name":"action_code","type":["null","string"]},{"default": null,"name":"affiliation_seller_code","type":["null","string"]},{"default": null,"name":"amount","type":["null","double"]},{"default": null,"name":"authenticated","type":["null","boolean"]},{"default": null,"name":"authorization_code","type":["null","string"]},{"default": null,"name":"authorization_timestamp","type":[{"type":"record","default": null,"name":"authorization_timestamp","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]},{"default": null,"name":"authorizer_response_code","type":["null","string"]},{"default": null,"name":"authorizer_switch","type":[{"type":"record","default": null,"name":"authorizer_switch","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"code","type":["null","string"]},{"default": null,"name":"transaction_identifier","type":["null","string"]}]},"null"]},{"default": null,"name":"billing_descriptor","type":["null","string"]},{"default": null,"name":"brand","type":["null","string"]},{"default": null,"name":"capture","type":[{"type":"array","items":[{"type":"record","default": null,"name":"capture","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"amount","type":["null","long"]},{"default": null,"name":"authorization_code","type":["null","string"]},{"default": null,"name":"authorizer_response_code","type":["null","string"]},{"default": null,"name":"createdAt","type":[{"type":"record","default": null,"name":"createdAt","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]},{"default": null,"name":"datetime_transaction","type":[{"type":"record","default": null,"name":"datetime_transaction","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]},{"default": null,"name":"retrieve_ref_number","type":["null","string"]},{"default": null,"name":"situation","type":[{"type":"record","default": null,"name":"situation","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default": null,"name":"error_code","type":["null","string"]},{"default": null,"name":"error_message","type":["null","string"]},{"default": null,"name":"status","type":["null","string"]},{"default": null,"name":"status_update_date","type":[{"type":"record","default": null,"name":"status_update_date","namespace":"topLevelRecord.payload.payload.capture.situation","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]}]},"null"]},{"default": null,"name":"system_trace_audit_number","type":["null","long"]},{"default": null,"name":"updatedAt","type":[{"type":"record","default": null,"name":"updatedAt","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]}]},"null"]},"null"]},{"default": null,"name":"capture_date","type":["null","string"]},{"default": null,"name":"card","type":[{"type":"record","default": null,"name":"card","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"bin","type":["null","string"]},{"default": null,"name":"brand","type":["null","string"]},{"default": null,"name":"cardholder_verification_method","type":["null","string"]},{"default": null,"name":"entry_mode","type":["null","string"]},{"default": null,"name":"issuer","type":["null","string"]},{"default": null,"name":"security_code","type":["null","string"]},{"default": null,"name":"service_code","type":[{"type":"record","default": null,"name":"service_code","namespace":"topLevelRecord.payload.payload.card","fields":[{"default": null,"name":"authorization_process","type":["null","string"]},{"default": null,"name":"chip","type":["null","boolean"]},{"default": null,"name":"interchange","type":["null","string"]},{"default": null,"name":"pin_required","type":["null","string"]},{"default": null,"name":"range_of_services","type":["null","string"]}]},"null"]},{"default": null,"name":"summarized_card_number","type":["null","string"]},{"default": null,"name":"token_ref_code","type":["null","string"]}]},"null"]},{"default": null,"name":"createdAt","type":[{"type":"record","default": null,"name":"createdAt","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]},{"default": null,"name":"currency","type":["null","string"]},{"default": null,"name":"currency_code","type":["null","long"]},{"default": null,"name":"date_undo_limit","type":["null","string"]},{"default": null,"name":"datetime_offset","type":["null","long"]},{"default": null,"name":"datetime_transaction","type":[{"type":"record","default": null,"name":"datetime_transaction","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]},{"default": null,"name":"days_to_capture","type":["null","long"]},{"default": null,"name":"delayed","type":["null","boolean"]},{"default": null,"name":"delivery_details","type":[{"type":"array","items":["null","string"]},"null"]},{"default": null,"name":"identity_origin","type":[{"type":"record","default": null,"name":"identity_origin","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"name","type":["null","string"]},{"default": null,"name":"type","type":["null","string"]}]},"null"]},{"default": null,"name":"installment","type":[{"type":"record","default": null,"name":"installment","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"number","type":["null","long"]},{"default": null,"name":"number_skip_payment","type":["null","long"]},{"default": null,"name":"type","type":["null","string"]}]},"null"]},{"default": null,"name":"interchange","type":["null","string"]},{"default": null,"name":"language_code","type":["null","string"]},{"default": null,"name":"location","type":["null","string"]},{"default": null,"name":"merchant_category_code","type":["null","long"]},{"default": null,"name":"merchant_installments","type":["null","boolean"]},{"default": null,"name":"number_installments","type":["null","long"]},{"default": null,"name":"operation","type":["null","string"]},{"default": null,"name":"original_payment_id","type":["null","string"]},{"default": null,"name":"original_transaction","type":[{"type":"record","default": null,"name":"original_transaction","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"amount","type":["null","long"]},{"default": null,"name":"authorization_code","type":["null","string"]},{"default": null,"name":"datetime_transaction","type":["null","string"]},{"default": null,"name":"retrieve_ref_number","type":["null","string"]},{"default": null,"name":"special_payment_indicator","type":["null","string"]},{"default": null,"name":"system_trace_audit_number","type":["null","long"]},{"default": null,"name":"terminal","type":[{"type":"record","default": null,"name":"terminal","namespace":"topLevelRecord.payload.payload.original_transaction","fields":[{"default": null,"name":"terminal_code","type":["null","string"]},{"default": null,"name":"transaction_channel_type","type":["null","string"]}]},"null"]},{"default": null,"name":"transaction_channel_type","type":["null","string"]}]},"null"]},{"default": null,"name":"payment_creation_timestamp","type":[{"type":"record","default": null,"name":"payment_creation_timestamp","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]},{"default": null,"name":"payment_id","type":["null","string"]},{"default": null,"name":"pre_authorization","type":["null","string"]},{"default": null,"name":"reason_code","type":["null","string"]},{"default": null,"name":"reason_message","type":["null","string"]},{"default": null,"name":"receipt","type":[{"type":"record","default": null,"name":"receipt","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"is_printed","type":["null","boolean"]},{"default": null,"name":"printed_date","type":[{"type":"record","default": null,"name":"printed_date","namespace":"topLevelRecord.payload.payload.receipt","fields":[{"default": null,"name":"date","type":["null","long"]},{"default": null,"name":"datetime","type":[{"type":"record","default": null,"name":"datetime","namespace":"topLevelRecord.payload.payload.receipt.printed_date","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]},{"default": null,"name":"datetime_offset","type":["null","long"]}]},"null"]}]},"null"]},{"default": null,"name":"receipt_ref_code","type":["null","string"]},{"default": null,"name":"receipt_reference_code","type":["null","string"]},{"default": null,"name":"reference_code","type":["null","string"]},{"default": null,"name":"retrieve_ref_number","type":["null","string"]},{"default": null,"name":"reversal","type":[{"type":"array","items":[{"type":"record","default": null,"name":"reversal","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"amount","type":["null","long"]},{"default": null,"name":"authorizer_response_code","type":["null","string"]},{"default": null,"name":"cancellation_timestamp","type":[{"type":"record","default": null,"name":"cancellation_timestamp","namespace":"topLevelRecord.payload.payload.reversal","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]},{"default": null,"name":"currency","type":["null","long"]},{"default": null,"name":"details","type":[{"type":"array","items":["null","string"]},"null"]},{"default": null,"name":"error_code","type":["null","string"]},{"default": null,"name":"error_type","type":["null","string"]},{"default": null,"name":"message","type":["null","string"]},{"default": null,"name":"retrieve_ref_number","type":["null","string"]},{"default": null,"name":"situation","type":["null","string"]},{"default": null,"name":"status","type":["null","string"]},{"default": null,"name":"status_update_date","type":["null","string"]},{"default": null,"name":"system_trace_audit_number","type":["null","long"]}]},"null"]},"null"]},{"default": null,"name":"save_card_data","type":["null","boolean"]},{"default": null,"name":"seller_code","type":["null","string"]},{"default": null,"name":"seller_id","type":["null","string"]},{"default": null,"name":"situation","type":[{"type":"record","default": null,"name":"situation","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"authorizer_response_code","type":["null","string"]},{"default": null,"name":"error_code","type":["null","string"]},{"default": null,"name":"error_message","type":["null","string"]},{"default": null,"name":"status","type":["null","string"]},{"default": null,"name":"status_update_date","type":[{"type":"record","default": null,"name":"status_update_date","namespace":"topLevelRecord.payload.payload.situation","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]}]},"null"]},{"default": null,"name":"special_payment_indicator","type":["null","string"]},{"default": null,"name":"system_trace_audit_number","type":["null","long"]},{"default": null,"name":"terminal","type":[{"type":"record","default": null,"name":"terminal","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"capabilities","type":[{"type":"record","default": null,"name":"capabilities","namespace":"topLevelRecord.payload.payload.terminal","fields":[{"default": null,"name":"authentication","type":["null","string"]},{"default": null,"name":"card_capture","type":["null","boolean"]},{"default": null,"name":"input","type":["null","string"]},{"default": null,"name":"output","type":["null","string"]},{"default": null,"name":"pin_capture","type":["null","long"]}]},"null"]},{"default": null,"name":"capability","type":["null","string"]},{"default": null,"name":"is_generated","type":["null","boolean"]},{"default": null,"name":"notification","type":[{"type":"record","default": null,"name":"notification","namespace":"topLevelRecord.payload.payload.terminal","fields":[{"default": null,"name":"notify_data","type":["null","string"]}]},"null"]},{"default": null,"name":"terminal_code","type":["null","string"]}]},"null"]},{"default": null,"name":"tip","type":[{"type":"record","default": null,"name":"tip","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"partial_amount","type":["null","long"]},{"default": null,"name":"value","type":["null","long"]},{"default": null,"name":"waiter_code","type":["null","string"]}]},"null"]},{"default": null,"name":"trade_name","type":["null","string"]},{"default": null,"name":"transaction_channel_type","type":["null","string"]},{"default": null,"name":"updatedAt","type":[{"type":"record","default": null,"name":"updatedAt","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]}]},"null"]}]},"null"]}]}""")
  val schemaCNPHandled = Schema.parse(""" {"type":"record","name":"topLevelRecord","fields":[{"default": null,"name":"offset","type":["null","long"]},{"default": null,"name":"timestamp","type":[{"type":"long","logicalType":"timestamp-micros"},"null"]},{"default": null,"name":"payload","type":[{"type":"record","default": null,"name":"payload","namespace":"topLevelRecord","fields":[{"default": null,"name":"metadata","type":[{"type":"record","default": null,"name":"metadata","namespace":"topLevelRecord.payload","fields":[{"default": null,"name":"_data","type":["null","string"]},{"default": null,"name":"coll","type":["null","string"]},{"default": null,"name":"db","type":["null","string"]},{"default": null,"name":"operation_type","type":["null","string"]}]},"null"]},{"default": null,"name":"payload","type":[{"type":"record","default": null,"name":"payload","namespace":"topLevelRecord.payload","fields":[{"default": null,"name":"__v","type":["null","long"]},{"default": null,"name":"_id","type":[{"type":"record","default": null,"name":"_id","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"oid","type":["null","string"]}]},"null"]},{"default": null,"name":"createdAt","type":[{"type":"record","default": null,"name":"createdAt","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]},{"default": null,"name":"payment_id","type":["null","string"]},{"default": null,"name":"reversal","type":[{"type":"array","items":[{"type":"record","default": null,"name":"reversal","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"details","type":[{"type":"array","items":["null","string"]},"null"]},{"default": null,"name":"error_code","type":["null","string"]},{"default": null,"name":"error_type","type":["null","string"]},{"default": null,"name":"message","type":["null","string"]},{"default": null,"name":"situation","type":["null","string"]},{"default": null,"name":"status_update_date","type":["null","string"]}]},"null"]},"null"]},{"default": null,"name":"updatedAt","type":[{"type":"record","default": null,"name":"updatedAt","namespace":"topLevelRecord.payload.payload","fields":[{"default": null,"name":"date","type":["null","long"]}]},"null"]}]},"null"]}]},"null"]},{"default": null,"name":"year","type":["null","int"]},{"default": null,"name":"month","type":["null","int"]},{"default": null,"name":"day","type":["null","int"]}]}""")
  val schemaCPAndCNPHsndled = """ {"type":"record","name":"topLevelRecord","fields":[{"default":null,"name":"offset","type":["null","long"]},{"default":null,"name":"timestamp","type":[{"type":"long","logicalType":"timestamp-micros"},"null"]},{"default":null,"name":"payload","type":[{"type":"record","default":null,"name":"payload","namespace":"topLevelRecord","fields":[{"default":null,"name":"metadata","type":[{"type":"record","default":null,"name":"metadata","namespace":"topLevelRecord.payload","fields":[{"default":null,"name":"coll","type":["null","string"]},{"default":null,"name":"db","type":["null","string"]},{"default":null,"name":"operation_type","type":["null","string"]}]},"null"]},{"default":null,"name":"payload","type":[{"type":"record","default":null,"name":"payload","namespace":"topLevelRecord.payload","fields":[{"default":null,"name":"__v","type":["null","long"]},{"default":null,"name":"_id","type":[{"type":"record","default":null,"name":"_id","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"oid","type":["null","string"]}]},"null"]},{"default":null,"name":"acquirer_code","type":["null","long"]},{"default":null,"name":"acquirer_country_code","type":["null","string"]},{"default":null,"name":"action_code","type":["null","string"]},{"default":null,"name":"affiliation_seller_code","type":["null","string"]},{"default":null,"name":"amount","type":["null","double"]},{"default":null,"name":"authenticated","type":["null","boolean"]},{"default":null,"name":"authentication","type":[{"type":"record","default":null,"name":"authentication","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"eci","type":["null","long"]},{"default":null,"name":"method","type":["null","string"]}]},"null"]},{"default":null,"name":"authorization_code","type":["null","string"]},{"default":null,"name":"authorization_timestamp","type":[{"type":"record","default":null,"name":"authorization_timestamp","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]},{"default":null,"name":"authorizer_response_code","type":["null","string"]},{"default":null,"name":"authorizer_switch","type":[{"type":"record","default":null,"name":"authorizer_switch","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"code","type":["null","string"]}]},"null"]},{"default":null,"name":"billing_descriptor","type":["null","string"]},{"default":null,"name":"capture","type":[{"type":"array","items":[{"type":"record","default":null,"name":"capture","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"amount","type":["null","double"]},{"default":null,"name":"authorization_code","type":["null","string"]},{"default":null,"name":"authorizer_response_code","type":["null","string"]},{"default":null,"name":"createdAt","type":[{"type":"record","default":null,"name":"createdAt","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]},{"default":null,"name":"datetime_transaction","type":[{"type":"record","default":null,"name":"datetime_transaction","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]},{"default":null,"name":"error","type":[{"type":"record","default":null,"name":"error","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default":null,"name":"details","type":[{"type":"array","items":["null","string"]},"null"]},{"default":null,"name":"error_code","type":["null","string"]},{"default":null,"name":"error_type","type":["null","string"]},{"default":null,"name":"message","type":["null","string"]},{"default":null,"name":"situation","type":["null","string"]},{"default":null,"name":"status_update_date","type":["null","string"]}]},"null"]},{"default":null,"name":"request","type":[{"type":"record","default":null,"name":"request","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default":null,"name":"datetime_transaction","type":["null","string"]},{"default":null,"name":"original_transaction","type":[{"type":"record","default":null,"name":"original_transaction","namespace":"topLevelRecord.payload.payload.capture.request","fields":[{"default":null,"name":"acquirer_code","type":["null","long"]},{"default":null,"name":"acquirer_country_code","type":["null","string"]},{"default":null,"name":"amount","type":["null","double"]},{"default":null,"name":"authorization_code","type":["null","string"]},{"default":null,"name":"capture_date","type":["null","string"]},{"default":null,"name":"card","type":[{"type":"record","default":null,"name":"card","namespace":"topLevelRecord.payload.payload.capture.request.original_transaction","fields":[{"default":null,"name":"brand","type":["null","string"]},{"default":null,"name":"entry_mode","type":["null","string"]}]},"null"]},{"default":null,"name":"currency","type":["null","long"]},{"default":null,"name":"datetime_transaction","type":["null","string"]},{"default":null,"name":"delayed","type":["null","boolean"]},{"default":null,"name":"language_code","type":["null","string"]},{"default":null,"name":"location","type":["null","string"]},{"default":null,"name":"merchant_category_code","type":["null","long"]},{"default":null,"name":"operation","type":["null","string"]},{"default":null,"name":"retrieve_ref_number","type":["null","string"]},{"default":null,"name":"seller_code","type":["null","string"]},{"default":null,"name":"situation","type":[{"type":"record","default":null,"name":"situation","namespace":"topLevelRecord.payload.payload.capture.request.original_transaction","fields":[{"default":null,"name":"status","type":["null","string"]}]},"null"]},{"default":null,"name":"system_trace_audit_number","type":["null","long"]},{"default":null,"name":"terminal","type":[{"type":"record","default":null,"name":"terminal","namespace":"topLevelRecord.payload.payload.capture.request.original_transaction","fields":[{"default":null,"name":"terminal_code","type":["null","string"]}]},"null"]},{"default":null,"name":"token_ref_code","type":["null","string"]},{"default":null,"name":"trade_name","type":["null","string"]},{"default":null,"name":"transaction_channel_type","type":["null","string"]}]},"null"]},{"default":null,"name":"system_trace_audit_number","type":["null","long"]}]},"null"]},{"default":null,"name":"response","type":[{"type":"record","default":null,"name":"response","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default":null,"name":"amount","type":["null","double"]},{"default":null,"name":"authorization_code","type":["null","string"]},{"default":null,"name":"currency","type":["null","long"]},{"default":null,"name":"data","type":[{"type":"record","default":null,"name":"data","namespace":"topLevelRecord.payload.payload.capture.response","fields":[{"default":null,"name":"amount","type":["null","double"]},{"default":null,"name":"authorization_code","type":["null","string"]},{"default":null,"name":"currency","type":["null","long"]},{"default":null,"name":"retrieve_ref_number","type":["null","string"]},{"default":null,"name":"seller_code","type":["null","string"]},{"default":null,"name":"situation","type":["null","string"]},{"default":null,"name":"system_trace_audit_number","type":["null","long"]}]},"null"]},{"default":null,"name":"retrieve_ref_number","type":["null","string"]},{"default":null,"name":"seller_code","type":["null","string"]},{"default":null,"name":"situation","type":["null","string"]},{"default":null,"name":"system_trace_audit_number","type":["null","long"]}]},"null"]},{"default":null,"name":"retrieve_ref_number","type":["null","string"]},{"default":null,"name":"situation","type":[{"type":"record","default":null,"name":"situation","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default":null,"name":"status","type":["null","string"]},{"default":null,"name":"status_update_date","type":[{"type":"record","default":null,"name":"status_update_date","namespace":"topLevelRecord.payload.payload.capture.situation","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]}]},"null"]},{"default":null,"name":"system_trace_audit_number","type":["null","long"]},{"default":null,"name":"updatedAt","type":[{"type":"record","default":null,"name":"updatedAt","namespace":"topLevelRecord.payload.payload.capture","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]}]},"null"]},"null"]},{"default":null,"name":"capture_date","type":["null","string"]},{"default":null,"name":"capture_mode","type":["null","string"]},{"default":null,"name":"card","type":[{"type":"record","default":null,"name":"card","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"bin","type":["null","string"]},{"default":null,"name":"brand","type":["null","string"]},{"default":null,"name":"number_token","type":["null","string"]},{"default":null,"name":"summarized_card_number","type":["null","string"]},{"default":null,"name":"token_ref_code","type":["null","string"]}]},"null"]},{"default":null,"name":"createdAt","type":[{"type":"record","default":null,"name":"createdAt","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]},{"default":null,"name":"currency","type":["null","string"]},{"default":null,"name":"currency_code","type":["null","long"]},{"default":null,"name":"date_undo_limit","type":["null","string"]},{"default":null,"name":"datetime_offset","type":["null","long"]},{"default":null,"name":"datetime_transaction","type":[{"type":"record","default":null,"name":"datetime_transaction","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]},{"default":null,"name":"days_to_capture","type":["null","long"]},{"default":null,"name":"delayed","type":["null","boolean"]},{"default":null,"name":"delivery_details","type":[{"type":"array","items":["null","string"]},"null"]},{"default":null,"name":"hours_to_capture","type":["null","long"]},{"default":null,"name":"identity_origin","type":[{"type":"record","default":null,"name":"identity_origin","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"name","type":["null","string"]},{"default":null,"name":"type","type":["null","string"]}]},"null"]},{"default":null,"name":"installment","type":[{"type":"record","default":null,"name":"installment","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"number","type":["null","long"]},{"default":null,"name":"type","type":["null","string"]}]},"null"]},{"default":null,"name":"interchange","type":["null","string"]},{"default":null,"name":"language_code","type":["null","string"]},{"default":null,"name":"location","type":["null","string"]},{"default":null,"name":"merchant_category_code","type":["null","long"]},{"default":null,"name":"message","type":["null","string"]},{"default":null,"name":"operation","type":["null","string"]},{"default":null,"name":"original_payment_id","type":["null","string"]},{"default":null,"name":"original_transaction","type":[{"type":"record","default":null,"name":"original_transaction","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"acquirer_code","type":["null","long"]},{"default":null,"name":"acquirer_country_code","type":["null","string"]},{"default":null,"name":"action_code","type":["null","string"]},{"default":null,"name":"amount","type":["null","double"]},{"default":null,"name":"authorization_code","type":["null","string"]},{"default":null,"name":"capture_date","type":["null","string"]},{"default":null,"name":"capture_mode","type":["null","string"]},{"default":null,"name":"card","type":[{"type":"record","default":null,"name":"card","namespace":"topLevelRecord.payload.payload.original_transaction","fields":[{"default":null,"name":"bin","type":["null","string"]},{"default":null,"name":"brand","type":["null","string"]},{"default":null,"name":"summarized_card_number","type":["null","string"]},{"default":null,"name":"token_ref_code","type":["null","string"]}]},"null"]},{"default":null,"name":"currency","type":["null","string"]},{"default":null,"name":"currency_code","type":["null","long"]},{"default":null,"name":"datetime_transaction","type":[{"type":"record","default":null,"name":"datetime_transaction","namespace":"topLevelRecord.payload.payload.original_transaction","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]},{"default":null,"name":"language_code","type":["null","string"]},{"default":null,"name":"location","type":["null","string"]},{"default":null,"name":"merchant_category_code","type":["null","long"]},{"default":null,"name":"retrieve_ref_number","type":["null","string"]},{"default":null,"name":"seller_code","type":["null","string"]},{"default":null,"name":"system_trace_audit_number","type":["null","long"]},{"default":null,"name":"terminal","type":[{"type":"record","default":null,"name":"terminal","namespace":"topLevelRecord.payload.payload.original_transaction","fields":[{"default":null,"name":"terminal_code","type":["null","string"]}]},"null"]},{"default":null,"name":"transaction_channel_type","type":["null","string"]}]},"null"]},{"default":null,"name":"payment_id","type":["null","string"]},{"default":null,"name":"pre_authorization","type":["null","string"]},{"default":null,"name":"recurring","type":[{"type":"record","default":null,"name":"recurring","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"payments_identification","type":["null","string"]}]},"null"]},{"default":null,"name":"reference_code","type":["null","string"]},{"default":null,"name":"retrieve_ref_number","type":["null","string"]},{"default":null,"name":"reversal","type":[{"type":"array","items":[{"type":"record","default":null,"name":"reversal","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"amount","type":["null","double"]},{"default":null,"name":"authorizer_response_code","type":["null","string"]},{"default":null,"name":"cancellation_timestamp","type":[{"type":"record","default":null,"name":"cancellation_timestamp","namespace":"topLevelRecord.payload.payload.reversal","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]},{"default":null,"name":"currency","type":["null","string"]},{"default":null,"name":"details","type":[{"type":"array","items":["null","string"]},"null"]},{"default":null,"name":"error_code","type":["null","string"]},{"default":null,"name":"error_type","type":["null","string"]},{"default":null,"name":"message","type":["null","string"]},{"default":null,"name":"retrieve_ref_number","type":["null","string"]},{"default":null,"name":"situation","type":["null","string"]},{"default":null,"name":"status","type":["null","string"]},{"default":null,"name":"status_update_date","type":["null","string"]},{"default":null,"name":"system_trace_audit_number","type":["null","long"]}]},"null"]},"null"]},{"default":null,"name":"save_card_data","type":["null","boolean"]},{"default":null,"name":"seller_code","type":["null","string"]},{"default":null,"name":"seller_id","type":["null","string"]},{"default":null,"name":"situation","type":[{"type":"record","default":null,"name":"situation","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"authorizer_response_code","type":["null","string"]},{"default":null,"name":"error_code","type":["null","string"]},{"default":null,"name":"error_message","type":["null","string"]},{"default":null,"name":"status","type":["null","string"]},{"default":null,"name":"status_update_date","type":[{"type":"record","default":null,"name":"status_update_date","namespace":"topLevelRecord.payload.payload.situation","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]}]},"null"]},{"default":null,"name":"system_trace_audit_number","type":["null","long"]},{"default":null,"name":"terminal","type":[{"type":"record","default":null,"name":"terminal","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"terminal_code","type":["null","string"]}]},"null"]},{"default":null,"name":"trade_name","type":["null","string"]},{"default":null,"name":"transaction_channel_type","type":["null","string"]},{"default":null,"name":"updatedAt","type":[{"type":"record","default":null,"name":"updatedAt","namespace":"topLevelRecord.payload.payload","fields":[{"default":null,"name":"date","type":["null","long"]}]},"null"]}]},"null"]}]},"null"]}]} """

  val schema = SchemaUtil.merge(
    schemaCNPHandled,
    schemaCPHandled
  )

  val df = spark.read.format("avro")
    .option("avroSchema", schemaCPHandled.toString)
    .load(pathCNPRelative)

  df.coalesce(1).write.format("avro").mode(SaveMode.Overwrite).save(s"$basePath/data")

}